<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4cb5ae;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-bottom: 0.5rem;
        }
        
        .app-description {
            max-width: 800px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .session-setup, .voting-area, .results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        label {
            font-weight: 600;
        }
        
        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
        }
        
        .btn-accent:hover {
            background-color: #3a9c96;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .card-value {
            aspect-ratio: 2/3;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .card-value:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-value.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .user-card {
            background-color: var(--light-color);
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-vote {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .user-vote.hidden {
            background-color: #cccccc;
        }
        
        .user-vote.voted {
            background-color: var(--success-color);
        }
        
        .user-vote.pending {
            background-color: var(--warning-color);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .result-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-count {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .average {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 15px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
        }
        
        .status-success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .status-info {
            background-color: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }
        
        .status-warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .session-url {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }
        
        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .facilitator-badge {
            background-color: var(--primary-color);
            color: white;
        }
        
        .participant-badge {
            background-color: var(--accent-color);
            color: white;
        }
        
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
            
            .session-setup {
                flex: 1;
            }
            
            .voting-area {
                flex: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Planning Poker</h1>
            <p class="app-description">Инструмент для оценки сложности задач в Agile-командах с разделением ролей на ведущего и участников.</p>
        </header>
        
        <div class="main-content">
            <div class="card session-setup">
                <h2>Настройка сессии</h2>
                <div class="form-group">
                    <label for="userName">Ваше имя:</label>
                    <input type="text" id="userName" placeholder="Введите ваше имя">
                </div>
                <div class="form-group">
                    <label for="userRole">Ваша роль:</label>
                    <select id="userRole">
                        <option value="participant">Участник (может голосовать)</option>
                        <option value="facilitator">Ведущий (не голосует, управляет сессией)</option>
                    </select>
                </div>
                
                <div id="facilitatorSection">
                    <div class="form-group">
                        <label for="sessionName">Название сессии:</label>
                        <input type="text" id="sessionName" placeholder="Название проекта или задачи">
                    </div>
                    <button id="createSession" class="btn-success">Создать сессию</button>
                </div>
                
                <div id="participantSection" class="hidden">
                    <div class="form-group">
                        <label for="sessionUrl">URL сессии:</label>
                        <input type="text" id="sessionUrl" placeholder="Введите URL сессии">
                    </div>
                    <button id="joinSession" class="btn-accent">Присоединиться к сессии</button>
                </div>
                
                <div id="sessionInfo" class="hidden">
                    <div class="status-message status-info">
                        <span id="sessionRoleInfo"></span>
                        <span id="currentSessionName"></span>
                    </div>
                    
                    <div id="facilitatorControls" class="hidden">
                        <div class="form-group">
                            <label for="taskName">Название задачи для оценки:</label>
                            <input type="text" id="taskName" placeholder="Опишите задачу">
                        </div>
                        <button id="startVoting" class="btn-accent">Начать голосование</button>
                        
                        <h3>Ссылка для участников:</h3>
                        <div class="session-url" id="sessionUrlDisplay"></div>
                        
                        <h3>Присоединившиеся участники:</h3>
                        <div class="user-list" id="facilitatorUserList">
                            <!-- Список участников для ведущего -->
                        </div>
                    </div>
                    
                    <div id="participantControls" class="hidden">
                        <div id="waitingForStart" class="status-message status-info">
                            Ожидание начала голосования...
                        </div>
                        
                        <div id="votingParticipant" class="hidden">
                            <h3 id="currentTaskName">Задача: </h3>
                            <p>Выберите карту, которая отражает вашу оценку сложности задачи:</p>
                            
                            <div class="card-grid" id="cardOptions">
                                <!-- Карты будут добавлены динамически -->
                            </div>
                            
                            <div class="status-message status-info" id="voteStatus">
                                Ваш голос еще не засчитан
                            </div>
                            
                            <button id="submitVote" class="btn-success" disabled>Подтвердить голос</button>
                        </div>
                        
                        <h3>Участники:</h3>
                        <div class="user-list" id="participantUserList">
                            <!-- Список участников для голосующего -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card voting-area">
                <h2>Область голосования</h2>
                <div id="facilitatorVoting" class="hidden">
                    <h3 id="facilitatorTaskName">Задача: </h3>
                    
                    <div class="status-message status-warning" id="facilitatorVoteStatus">
                        Ожидание голосования участников...
                    </div>
                    
                    <button id="revealVotes" class="btn-warning" disabled>Показать результаты</button>
                    
                    <h3>Участники:</h3>
                    <div class="user-list" id="facilitatorVotingUserList">
                        <!-- Список участников для ведущего во время голосования -->
                    </div>
                </div>
                
                <div id="waitingArea" class="status-message status-info">
                    Настройте сессию для начала работы
                </div>
            </div>
        </div>
        
        <div class="card results hidden" id="resultsSection">
            <h2>Результаты голосования</h2>
            <div class="results-grid" id="resultsGrid">
                <!-- Результаты будут добавлены динамически -->
            </div>
            <div class="average" id="averageResult">
                Среднее значение: 
            </div>
            <div class="controls">
                <button id="newVoting" class="btn-accent">Новое голосование</button>
                <button id="resetSession" class="btn-danger">Завершить сессию</button>
            </div>
        </div>
    </div>

    <script>
        // Данные приложения
        const appState = {
            currentUser: null,
            userRole: null,
            sessionId: null,
            sessionName: null,
            currentTask: null,
            users: [],
            votes: {},
            votingActive: false,
            resultsRevealed: false
        };

        // Набор карт (только 2, 6, 9)
        const cardSet = ['2', '6', '9'];

        // Элементы DOM
        const elements = {
            userName: document.getElementById('userName'),
            userRole: document.getElementById('userRole'),
            facilitatorSection: document.getElementById('facilitatorSection'),
            participantSection: document.getElementById('participantSection'),
            sessionName: document.getElementById('sessionName'),
            createSession: document.getElementById('createSession'),
            sessionUrl: document.getElementById('sessionUrl'),
            joinSession: document.getElementById('joinSession'),
            sessionInfo: document.getElementById('sessionInfo'),
            sessionRoleInfo: document.getElementById('sessionRoleInfo'),
            currentSessionName: document.getElementById('currentSessionName'),
            facilitatorControls: document.getElementById('facilitatorControls'),
            participantControls: document.getElementById('participantControls'),
            taskName: document.getElementById('taskName'),
            startVoting: document.getElementById('startVoting'),
            sessionUrlDisplay: document.getElementById('sessionUrlDisplay'),
            facilitatorUserList: document.getElementById('facilitatorUserList'),
            waitingForStart: document.getElementById('waitingForStart'),
            votingParticipant: document.getElementById('votingParticipant'),
            currentTaskName: document.getElementById('currentTaskName'),
            cardOptions: document.getElementById('cardOptions'),
            voteStatus: document.getElementById('voteStatus'),
            submitVote: document.getElementById('submitVote'),
            participantUserList: document.getElementById('participantUserList'),
            facilitatorVoting: document.getElementById('facilitatorVoting'),
            facilitatorTaskName: document.getElementById('facilitatorTaskName'),
            facilitatorVoteStatus: document.getElementById('facilitatorVoteStatus'),
            revealVotes: document.getElementById('revealVotes'),
            facilitatorVotingUserList: document.getElementById('facilitatorVotingUserList'),
            waitingArea: document.getElementById('waitingArea'),
            resultsSection: document.getElementById('resultsSection'),
            resultsGrid: document.getElementById('resultsGrid'),
            averageResult: document.getElementById('averageResult'),
            newVoting: document.getElementById('newVoting'),
            resetSession: document.getElementById('resetSession')
        };

        // Инициализация приложения
        function initApp() {
            // Обработчик изменения роли
            elements.userRole.addEventListener('change', toggleRoleSections);
            
            // Назначение обработчиков событий
            elements.createSession.addEventListener('click', createSession);
            elements.joinSession.addEventListener('click', joinSession);
            elements.startVoting.addEventListener('click', startVoting);
            elements.submitVote.addEventListener('click', submitVote);
            elements.revealVotes.addEventListener('click', revealVotes);
            elements.newVoting.addEventListener('click', newVoting);
            elements.resetSession.addEventListener('click', resetSession);
            
            // Проверка параметров URL для автоматического присоединения
            checkUrlParams();
            
            // Инициализация интервала для обновления состояния
            setInterval(updateSessionState, 2000);
        }

        // Переключение секций в зависимости от роли
        function toggleRoleSections() {
            const role = elements.userRole.value;
            
            if (role === 'facilitator') {
                elements.facilitatorSection.classList.remove('hidden');
                elements.participantSection.classList.add('hidden');
            } else {
                elements.facilitatorSection.classList.add('hidden');
                elements.participantSection.classList.remove('hidden');
            }
        }

        // Проверка параметров URL для автоматического присоединения
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            if (sessionId) {
                elements.sessionUrl.value = window.location.href.split('?')[0] + '?session=' + sessionId;
                elements.userRole.value = 'participant';
                toggleRoleSections();
            }
        }

        // Создание сессии
        function createSession() {
            const userName = elements.userName.value.trim();
            const sessionName = elements.sessionName.value.trim();
            
            if (!userName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            if (!sessionName) {
                alert('Пожалуйста, введите название сессии');
                return;
            }
            
            // Генерация ID сессии
            const sessionId = generateSessionId();
            
            appState.currentUser = userName;
            appState.userRole = 'facilitator';
            appState.sessionId = sessionId;
            appState.sessionName = sessionName;
            appState.users = [{name: userName, role: 'facilitator', voted: false}];
            
            // Обновление UI
            elements.sessionRoleInfo.innerHTML = `Вы - <span class="role-badge facilitator-badge">Ведущий</span>. Сессия: `;
            elements.currentSessionName.textContent = sessionName;
            elements.sessionInfo.classList.remove('hidden');
            elements.facilitatorControls.classList.remove('hidden');
            elements.participantControls.classList.add('hidden');
            elements.waitingArea.classList.add('hidden');
            
            // Показать URL для присоединения
            const sessionUrl = window.location.href.split('?')[0] + '?session=' + sessionId;
            elements.sessionUrlDisplay.textContent = sessionUrl;
            
            updateUserList();
            saveState();
        }

        // Присоединение к сессии
        function joinSession() {
            const userName = elements.userName.value.trim();
            const sessionUrl = elements.sessionUrl.value.trim();
            
            if (!userName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            if (!sessionUrl) {
                alert('Пожалуйста, введите URL сессии');
                return;
            }
            
            // Извлечение ID сессии из URL
            const urlParams = new URLSearchParams(new URL(sessionUrl).search);
            const sessionId = urlParams.get('session');
            
            if (!sessionId) {
                alert('Неверный URL сессии');
                return;
            }
            
            // Загрузка состояния сессии
            const savedState = localStorage.getItem('planningPoker_' + sessionId);
            if (!savedState) {
                alert('Сессия не найдена или была завершена');
                return;
            }
            
            const sessionState = JSON.parse(savedState);
            
            // Проверка, не присоединен ли уже пользователь с таким именем
            if (sessionState.users.some(user => user.name === userName)) {
                alert('Пользователь с таким именем уже присоединился к сессии');
                return;
            }
            
            appState.currentUser = userName;
            appState.userRole = 'participant';
            appState.sessionId = sessionId;
            appState.sessionName = sessionState.sessionName;
            appState.users = sessionState.users;
            appState.currentTask = sessionState.currentTask;
            appState.votingActive = sessionState.votingActive;
            appState.votes = sessionState.votes;
            
            // Добавление пользователя в список
            appState.users.push({name: userName, role: 'participant', voted: false});
            
            // Обновление UI
            elements.sessionRoleInfo.innerHTML = `Вы - <span class="role-badge participant-badge">Участник</span>. Сессия: `;
            elements.currentSessionName.textContent = sessionState.sessionName;
            elements.sessionInfo.classList.remove('hidden');
            elements.facilitatorControls.classList.add('hidden');
            elements.participantControls.classList.remove('hidden');
            elements.waitingArea.classList.add('hidden');
            
            if (appState.votingActive) {
                startVotingForParticipant();
            }
            
            updateUserList();
            saveState();
        }

        // Начало голосования
        function startVoting() {
            const taskName = elements.taskName.value.trim();
            
            if (!taskName) {
                alert('Пожалуйста, введите название задачи');
                return;
            }
            
            appState.currentTask = taskName;
            appState.votingActive = true;
            appState.votes = {};
            appState.resultsRevealed = false;
            
            // Сброс статуса голосования для всех участников
            appState.users.forEach(user => {
                if (user.role === 'participant') {
                    user.voted = false;
                }
            });
            
            // Обновление UI для ведущего
            elements.facilitatorVoting.classList.remove('hidden');
            elements.facilitatorTaskName.textContent = `Задача: ${taskName}`;
            elements.revealVotes.disabled = true;
            
            updateUserList();
            saveState();
        }

        // Начало голосования для участника
        function startVotingForParticipant() {
            elements.waitingForStart.classList.add('hidden');
            elements.votingParticipant.classList.remove('hidden');
            elements.currentTaskName.textContent = `Задача: ${appState.currentTask}`;
            
            // Создание карт для голосования
            createCardOptions();
            
            // Сброс статуса голосования
            elements.voteStatus.textContent = 'Ваш голос еще не засчитан';
            elements.voteStatus.className = 'status-message status-info';
            elements.submitVote.disabled = true;
        }

        // Создание карт для голосования
        function createCardOptions() {
            elements.cardOptions.innerHTML = '';
            
            cardSet.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-value';
                cardElement.textContent = card;
                cardElement.addEventListener('click', () => selectCard(cardElement, card));
                elements.cardOptions.appendChild(cardElement);
            });
        }

        // Выбор карты
        function selectCard(cardElement, value) {
            // Сброс выделения всех карт
            document.querySelectorAll('.card-value').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Выделение выбранной карты
            cardElement.classList.add('selected');
            appState.selectedCard = value;
            elements.submitVote.disabled = false;
        }

        // Отправка голоса
        function submitVote() {
            if (!appState.selectedCard) return;
            
            // Обновление состояния
            appState.votes[appState.currentUser] = appState.selectedCard;
            const userIndex = appState.users.findIndex(user => user.name === appState.currentUser);
            if (userIndex !== -1) {
                appState.users[userIndex].voted = true;
            }
            
            // Обновление UI
            elements.voteStatus.textContent = `Вы проголосовали: ${appState.selectedCard}`;
            elements.voteStatus.className = 'status-message status-success';
            elements.submitVote.disabled = true;
            
            updateUserList();
            saveState();
        }

        // Показать результаты
        function revealVotes() {
            appState.votingActive = false;
            appState.resultsRevealed = true;
            
            showResults();
            saveState();
        }

        // Показать результаты голосования
        function showResults() {
            elements.facilitatorVoting.classList.add('hidden');
            elements.votingParticipant.classList.add('hidden');
            elements.resultsSection.classList.remove('hidden');
            
            // Подсчет результатов
            const voteCounts = {};
            let numericSum = 0;
            let numericCount = 0;
            
            Object.values(appState.votes).forEach(vote => {
                voteCounts[vote] = (voteCounts[vote] || 0) + 1;
                
                // Подсчет среднего для числовых значений
                const numericValue = parseFloat(vote);
                if (!isNaN(numericValue)) {
                    numericSum += numericValue;
                    numericCount++;
                }
            });
            
            // Отображение результатов
            elements.resultsGrid.innerHTML = '';
            Object.keys(voteCounts).sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                return numA - numB;
            }).forEach(value => {
                const count = voteCounts[value];
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                const resultValue = document.createElement('div');
                resultValue.className = 'result-value';
                resultValue.textContent = value;
                
                const resultCount = document.createElement('div');
                resultCount.className = 'result-count';
                resultCount.textContent = `${count} голос(ов)`;
                
                resultCard.appendChild(resultValue);
                resultCard.appendChild(resultCount);
                elements.resultsGrid.appendChild(resultCard);
            });
            
            // Отображение среднего значения
            if (numericCount > 0) {
                const average = numericSum / numericCount;
                elements.averageResult.textContent = `Среднее значение: ${average.toFixed(2)}`;
            } else {
                elements.averageResult.textContent = 'Среднее значение: не вычислено';
            }
        }

        // Новое голосование
        function newVoting() {
            appState.votingActive = false;
            appState.resultsRevealed = false;
            appState.votes = {};
            
            // Сброс статуса голосования для всех участников
            appState.users.forEach(user => {
                user.voted = false;
            });
            
            elements.resultsSection.classList.add('hidden');
            
            if (appState.userRole === 'facilitator') {
                elements.facilitatorVoting.classList.add('hidden');
            } else {
                elements.waitingForStart.classList.remove('hidden');
                elements.votingParticipant.classList.add('hidden');
            }
            
            updateUserList();
            saveState();
        }

        // Завершение сессии
        function resetSession() {
            if (confirm('Вы уверены, что хотите завершить сессию? Все данные будут удалены.')) {
                // Удаление состояния сессии из localStorage
                if (appState.sessionId) {
                    localStorage.removeItem('planningPoker_' + appState.sessionId);
                }
                
                // Перезагрузка страницы
                window.location.href = window.location.href.split('?')[0];
            }
        }

        // Обновление списка пользователей
        function updateUserList() {
            // Для ведущего в настройках
            elements.facilitatorUserList.innerHTML = '';
            
            // Для участника
            elements.participantUserList.innerHTML = '';
            
            // Для ведущего во время голосования
            elements.facilitatorVotingUserList.innerHTML = '';
            
            appState.users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                const userName = document.createElement('span');
                userName.textContent = user.name;
                
                const userBadge = document.createElement('span');
                userBadge.className = `role-badge ${user.role === 'facilitator' ? 'facilitator-badge' : 'participant-badge'}`;
                userBadge.textContent = user.role === 'facilitator' ? 'В' : 'У';
                
                const userVote = document.createElement('div');
                userVote.className = 'user-vote';
                
                if (user.role === 'facilitator') {
                    userVote.textContent = '—';
                    userVote.classList.add('hidden');
                } else if (user.voted && appState.resultsRevealed) {
                    userVote.textContent = appState.votes[user.name] || '?';
                    userVote.classList.remove('hidden');
                } else if (user.voted) {
                    userVote.textContent = '✓';
                    userVote.classList.add('voted');
                } else {
                    userVote.textContent = '?';
                    userVote.classList.add('pending');
                }
                
                userCard.appendChild(userName);
                userCard.appendChild(userBadge);
                userCard.appendChild(userVote);
                
                // Добавление в соответствующие списки
                elements.facilitatorUserList.appendChild(userCard.cloneNode(true));
                elements.participantUserList.appendChild(userCard.cloneNode(true));
                elements.facilitatorVotingUserList.appendChild(userCard.cloneNode(true));
            });
            
            // Обновление состояния кнопки "Показать результаты" для ведущего
            if (appState.userRole === 'facilitator' && appState.votingActive) {
                const allVoted = appState.users.filter(user => user.role === 'participant')
                    .every(user => user.voted);
                elements.revealVotes.disabled = !allVoted;
                
                if (allVoted) {
                    elements.facilitatorVoteStatus.textContent = 'Все участники проголосовали!';
                    elements.facilitatorVoteStatus.className = 'status-message status-success';
                } else {
                    const votedCount = appState.users.filter(user => user.role === 'participant' && user.voted).length;
                    const totalCount = appState.users.filter(user => user.role === 'participant').length;
                    elements.facilitatorVoteStatus.textContent = `Проголосовало: ${votedCount} из ${totalCount}`;
                    elements.facilitatorVoteStatus.className = 'status-message status-warning';
                }
            }
        }

        // Обновление состояния сессии
        function updateSessionState() {
            if (appState.sessionId) {
                const savedState = localStorage.getItem('planningPoker_' + appState.sessionId);
                if (savedState) {
                    const sessionState = JSON.parse(savedState);
                    
                    // Обновление состояния, если пользователь участник
                    if (appState.userRole === 'participant') {
                        // Обновление списка пользователей
                        appState.users = sessionState.users;
                        
                        // Обновление состояния голосования
                        if (sessionState.votingActive && !appState.votingActive) {
                            appState.votingActive = true;
                            appState.currentTask = sessionState.currentTask;
                            startVotingForParticipant();
                        } else if (!sessionState.votingActive && appState.votingActive) {
                            appState.votingActive = false;
                        }
                        
                        // Обновление результатов
                        if (sessionState.resultsRevealed && !appState.resultsRevealed) {
                            appState.resultsRevealed = true;
                            appState.votes = sessionState.votes;
                            showResults();
                        }
                        
                        updateUserList();
                    }
                }
            }
        }

        // Сохранение состояния в localStorage
        function saveState() {
            if (appState.sessionId) {
                localStorage.setItem('planningPoker_' + appState.sessionId, JSON.stringify(appState));
            }
        }

        // Генерация ID сессии
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 10);
        }

        // Инициализация приложения при загрузке
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
