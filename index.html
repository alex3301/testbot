<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4cb5ae;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-bottom: 0.5rem;
        }
        
        .app-description {
            max-width: 800px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .session-setup, .voting-area, .results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        label {
            font-weight: 600;
        }
        
        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
        }
        
        .btn-accent:hover {
            background-color: #3a9c96;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .card-value {
            aspect-ratio: 2/3;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .card-value:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-value.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .user-card {
            background-color: var(--light-color);
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-vote {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .user-vote.hidden {
            background-color: #cccccc;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .result-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-count {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .average {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 15px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
        }
        
        .status-success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .status-info {
            background-color: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
            
            .session-setup {
                flex: 1;
            }
            
            .voting-area {
                flex: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Planning Poker</h1>
            <p class="app-description">Инструмент для оценки сложности задач в Agile-командах. Работает полностью автономно в браузере.</p>
        </header>
        
        <div class="main-content">
            <div class="card session-setup">
                <h2>Настройка сессии</h2>
                <div class="form-group">
                    <label for="userName">Ваше имя:</label>
                    <input type="text" id="userName" placeholder="Введите ваше имя">
                </div>
                <div class="form-group">
                    <label for="sessionName">Название сессии:</label>
                    <input type="text" id="sessionName" placeholder="Название проекта или задачи">
                </div>
                <div class="form-group">
                    <label for="cardSet">Набор карт:</label>
                    <select id="cardSet">
                        <option value="fibonacci">Фибоначчи (0, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89)</option>
                        <option value="tshirt">Размеры футболок (XS, S, M, L, XL)</option>
                        <option value="powers">Степени двойки (0, 1, 2, 4, 8, 16, 32)</option>
                    </select>
                </div>
                <button id="joinSession" class="btn-success">Присоединиться к сессии</button>
                
                <div id="sessionInfo" class="hidden">
                    <div class="status-message status-info">
                        Вы присоединились к сессии: <strong id="currentSessionName"></strong>
                    </div>
                    <div class="form-group">
                        <label for="taskName">Название задачи для оценки:</label>
                        <input type="text" id="taskName" placeholder="Опишите задачу">
                    </div>
                    <button id="startVoting" class="btn-accent">Начать голосование</button>
                </div>
            </div>
            
            <div class="card voting-area">
                <h2>Область голосования</h2>
                <div id="votingSetup" class="hidden">
                    <h3 id="currentTaskName">Задача: </h3>
                    <p>Выберите карту, которая отражает вашу оценку сложности задачи:</p>
                    
                    <div class="card-grid" id="cardOptions">
                        <!-- Карты будут добавлены динамически -->
                    </div>
                    
                    <div class="status-message status-info" id="voteStatus">
                        Ваш голос еще не засчитан
                    </div>
                    
                    <button id="submitVote" class="btn-success" disabled>Подтвердить голос</button>
                    <button id="revealVotes" class="btn-accent hidden">Показать результаты</button>
                    
                    <h3>Участники:</h3>
                    <div class="user-list" id="userList">
                        <!-- Список пользователей будет добавлен динамически -->
                    </div>
                </div>
                
                <div id="waitingForStart" class="status-message status-info">
                    Ожидание начала голосования...
                </div>
            </div>
        </div>
        
        <div class="card results hidden" id="resultsSection">
            <h2>Результаты голосования</h2>
            <div class="results-grid" id="resultsGrid">
                <!-- Результаты будут добавлены динамически -->
            </div>
            <div class="average" id="averageResult">
                Среднее значение: 
            </div>
            <div class="controls">
                <button id="newVoting" class="btn-accent">Новое голосование</button>
                <button id="resetSession" class="btn-danger">Сбросить сессию</button>
            </div>
        </div>
    </div>

    <script>
        // Данные приложения
        const appState = {
            currentUser: null,
            sessionName: null,
            cardSet: 'fibonacci',
            currentTask: null,
            users: [],
            votes: {},
            votingActive: false,
            resultsRevealed: false
        };

        // Наборы карт
        const cardSets = {
            fibonacci: ['0', '1', '2', '3', '5', '8', '13', '21', '34', '55', '89', '?', '☕'],
            tshirt: ['XS', 'S', 'M', 'L', 'XL', '?', '☕'],
            powers: ['0', '1', '2', '4', '8', '16', '32', '?', '☕']
        };

        // Элементы DOM
        const elements = {
            userName: document.getElementById('userName'),
            sessionName: document.getElementById('sessionName'),
            cardSet: document.getElementById('cardSet'),
            joinSession: document.getElementById('joinSession'),
            sessionInfo: document.getElementById('sessionInfo'),
            currentSessionName: document.getElementById('currentSessionName'),
            taskName: document.getElementById('taskName'),
            startVoting: document.getElementById('startVoting'),
            votingSetup: document.getElementById('votingSetup'),
            currentTaskName: document.getElementById('currentTaskName'),
            cardOptions: document.getElementById('cardOptions'),
            voteStatus: document.getElementById('voteStatus'),
            submitVote: document.getElementById('submitVote'),
            revealVotes: document.getElementById('revealVotes'),
            userList: document.getElementById('userList'),
            waitingForStart: document.getElementById('waitingForStart'),
            resultsSection: document.getElementById('resultsSection'),
            resultsGrid: document.getElementById('resultsGrid'),
            averageResult: document.getElementById('averageResult'),
            newVoting: document.getElementById('newVoting'),
            resetSession: document.getElementById('resetSession')
        };

        // Инициализация приложения
        function initApp() {
            // Восстановление состояния из localStorage
            const savedState = localStorage.getItem('planningPokerState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(appState, parsedState);
                
                // Восстановление UI
                if (appState.currentUser) {
                    elements.userName.value = appState.currentUser;
                }
                if (appState.sessionName) {
                    elements.sessionName.value = appState.sessionName;
                    elements.currentSessionName.textContent = appState.sessionName;
                    elements.sessionInfo.classList.remove('hidden');
                }
                elements.cardSet.value = appState.cardSet;
                
                if (appState.votingActive) {
                    startVotingUI(appState.currentTask);
                } else if (appState.resultsRevealed) {
                    showResults();
                }
                
                updateUserList();
            }
            
            // Назначение обработчиков событий
            elements.joinSession.addEventListener('click', joinSession);
            elements.startVoting.addEventListener('click', startVoting);
            elements.submitVote.addEventListener('click', submitVote);
            elements.revealVotes.addEventListener('click', revealVotes);
            elements.newVoting.addEventListener('click', newVoting);
            elements.resetSession.addEventListener('click', resetSession);
        }

        // Присоединение к сессии
        function joinSession() {
            const userName = elements.userName.value.trim();
            const sessionName = elements.sessionName.value.trim();
            
            if (!userName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            if (!sessionName) {
                alert('Пожалуйста, введите название сессии');
                return;
            }
            
            appState.currentUser = userName;
            appState.sessionName = sessionName;
            appState.cardSet = elements.cardSet.value;
            
            // Добавление пользователя в список
            if (!appState.users.includes(userName)) {
                appState.users.push(userName);
            }
            
            // Обновление UI
            elements.currentSessionName.textContent = sessionName;
            elements.sessionInfo.classList.remove('hidden');
            elements.votingSetup.classList.add('hidden');
            elements.waitingForStart.classList.remove('hidden');
            
            updateUserList();
            saveState();
        }

        // Начало голосования
        function startVoting() {
            const taskName = elements.taskName.value.trim();
            
            if (!taskName) {
                alert('Пожалуйста, введите название задачи');
                return;
            }
            
            appState.currentTask = taskName;
            appState.votingActive = true;
            appState.votes = {};
            appState.resultsRevealed = false;
            
            startVotingUI(taskName);
            saveState();
        }

        // Обновление UI для начала голосования
        function startVotingUI(taskName) {
            elements.currentTaskName.textContent = `Задача: ${taskName}`;
            elements.votingSetup.classList.remove('hidden');
            elements.waitingForStart.classList.add('hidden');
            elements.resultsSection.classList.add('hidden');
            
            // Создание карт для голосования
            createCardOptions();
            
            // Сброс статуса голосования
            elements.voteStatus.textContent = 'Ваш голос еще не засчитан';
            elements.voteStatus.className = 'status-message status-info';
            elements.submitVote.disabled = true;
            elements.revealVotes.classList.add('hidden');
            
            updateUserList();
        }

        // Создание карт для голосования
        function createCardOptions() {
            elements.cardOptions.innerHTML = '';
            const cards = cardSets[appState.cardSet];
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-value';
                cardElement.textContent = card;
                cardElement.addEventListener('click', () => selectCard(cardElement, card));
                elements.cardOptions.appendChild(cardElement);
            });
        }

        // Выбор карты
        function selectCard(cardElement, value) {
            // Сброс выделения всех карт
            document.querySelectorAll('.card-value').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Выделение выбранной карты
            cardElement.classList.add('selected');
            appState.selectedCard = value;
            elements.submitVote.disabled = false;
        }

        // Отправка голоса
        function submitVote() {
            if (!appState.selectedCard) return;
            
            appState.votes[appState.currentUser] = appState.selectedCard;
            
            // Обновление UI
            elements.voteStatus.textContent = `Вы проголосовали: ${appState.selectedCard}`;
            elements.voteStatus.className = 'status-message status-success';
            elements.submitVote.disabled = true;
            
            // Проверка, все ли проголосовали
            const allVoted = appState.users.every(user => appState.votes[user]);
            if (allVoted) {
                elements.revealVotes.classList.remove('hidden');
            }
            
            updateUserList();
            saveState();
        }

        // Показать результаты
        function revealVotes() {
            appState.votingActive = false;
            appState.resultsRevealed = true;
            
            showResults();
            saveState();
        }

        // Показать результаты голосования
        function showResults() {
            elements.votingSetup.classList.add('hidden');
            elements.resultsSection.classList.remove('hidden');
            
            // Подсчет результатов
            const voteCounts = {};
            let numericSum = 0;
            let numericCount = 0;
            
            Object.values(appState.votes).forEach(vote => {
                voteCounts[vote] = (voteCounts[vote] || 0) + 1;
                
                // Подсчет среднего для числовых значений
                const numericValue = parseFloat(vote);
                if (!isNaN(numericValue)) {
                    numericSum += numericValue;
                    numericCount++;
                }
            });
            
            // Отображение результатов
            elements.resultsGrid.innerHTML = '';
            Object.keys(voteCounts).sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                if (!isNaN(numA)) return -1;
                if (!isNaN(numB)) return 1;
                return a.localeCompare(b);
            }).forEach(value => {
                const count = voteCounts[value];
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                const resultValue = document.createElement('div');
                resultValue.className = 'result-value';
                resultValue.textContent = value;
                
                const resultCount = document.createElement('div');
                resultCount.className = 'result-count';
                resultCount.textContent = `${count} голос(ов)`;
                
                resultCard.appendChild(resultValue);
                resultCard.appendChild(resultCount);
                elements.resultsGrid.appendChild(resultCard);
            });
            
            // Отображение среднего значения
            if (numericCount > 0) {
                const average = numericSum / numericCount;
                elements.averageResult.textContent = `Среднее значение: ${average.toFixed(2)}`;
            } else {
                elements.averageResult.textContent = 'Среднее значение: не вычислено (нечисловые оценки)';
            }
        }

        // Новое голосование
        function newVoting() {
            elements.taskName.value = '';
            elements.resultsSection.classList.add('hidden');
            elements.sessionInfo.classList.remove('hidden');
        }

        // Сброс сессии
        function resetSession() {
            if (confirm('Вы уверены, что хотите сбросить сессию? Все данные будут удалены.')) {
                // Сброс состояния приложения
                appState.currentUser = null;
                appState.sessionName = null;
                appState.currentTask = null;
                appState.users = [];
                appState.votes = {};
                appState.votingActive = false;
                appState.resultsRevealed = false;
                
                // Сброс UI
                elements.userName.value = '';
                elements.sessionName.value = '';
                elements.taskName.value = '';
                elements.sessionInfo.classList.add('hidden');
                elements.votingSetup.classList.add('hidden');
                elements.waitingForStart.classList.remove('hidden');
                elements.resultsSection.classList.add('hidden');
                elements.userList.innerHTML = '';
                
                // Очистка localStorage
                localStorage.removeItem('planningPokerState');
            }
        }

        // Обновление списка пользователей
        function updateUserList() {
            elements.userList.innerHTML = '';
            
            appState.users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                const userName = document.createElement('span');
                userName.textContent = user;
                
                const userVote = document.createElement('div');
                userVote.className = 'user-vote';
                
                if (appState.votes[user] && appState.resultsRevealed) {
                    userVote.textContent = appState.votes[user];
                    userVote.classList.remove('hidden');
                } else if (appState.votes[user] && !appState.resultsRevealed) {
                    userVote.textContent = '✓';
                    userVote.classList.remove('hidden');
                } else {
                    userVote.textContent = '?';
                    userVote.classList.add('hidden');
                }
                
                userCard.appendChild(userName);
                userCard.appendChild(userVote);
                elements.userList.appendChild(userCard);
            });
        }

        // Сохранение состояния в localStorage
        function saveState() {
            localStorage.setItem('planningPokerState', JSON.stringify(appState));
        }

        // Инициализация приложения при загрузке
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
